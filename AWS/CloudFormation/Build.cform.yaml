AWSTemplateFormatVersion: 2010-09-09
Description: ''
Metadata:
  'AWS::CloudFormation::Designer':
    cad62f0d-0fa3-4ffb-ba8b-e0105a215fb3:
      size:
        width: 650
        height: 650
      position:
        x: 80
        'y': -20
      z: 0
      embeds:
        - ccd87952-210d-498d-8ba0-0772fb2f1a65
        - 87cbe0f5-7bd7-43ba-b2d8-1b9cc61cee6c
        - bcca50e2-1b9b-416a-9b50-6e6120ed935c
        - 0d15f27f-8d6c-4b1c-bed7-f99581fd2b8b
        - a3ebeab3-3f21-4c0e-9ddb-388dda810fef
        - 41356c17-0971-45ae-aad0-5783024dcbb2
        - ca2fd767-3130-4e40-861e-673e8d78ee5a
        - f9a2237e-e858-4a0f-b325-5c4c42e0c4cc
    ca2fd767-3130-4e40-861e-673e8d78ee5a:
      size:
        width: 240
        height: 190
      position:
        x: 110
        'y': 20
      z: 1
      parent: cad62f0d-0fa3-4ffb-ba8b-e0105a215fb3
      embeds:
        - 491d4130-1f07-4b4d-80e9-9a8a3a526909
        - ecee7473-760e-4417-bce5-753e5570474e
      iscontainedinside:
        - cad62f0d-0fa3-4ffb-ba8b-e0105a215fb3
        - cad62f0d-0fa3-4ffb-ba8b-e0105a215fb3
    41356c17-0971-45ae-aad0-5783024dcbb2:
      size:
        width: 230
        height: 190
      position:
        x: 470
        'y': 20
      z: 1
      parent: cad62f0d-0fa3-4ffb-ba8b-e0105a215fb3
      embeds:
        - 938433ac-b9fd-45de-8ac2-e7f9ebe3f7ef
        - 9b4996d8-76d0-410a-85b2-b5791aa13753
      iscontainedinside:
        - cad62f0d-0fa3-4ffb-ba8b-e0105a215fb3
        - cad62f0d-0fa3-4ffb-ba8b-e0105a215fb3
    a3ebeab3-3f21-4c0e-9ddb-388dda810fef:
      size:
        width: 240
        height: 250
      position:
        x: 110
        'y': 370
      z: 1
      parent: cad62f0d-0fa3-4ffb-ba8b-e0105a215fb3
      embeds:
        - d49f2930-811c-4c46-bc11-c6b1623a838d
        - 0304f5e2-d1e9-4fc0-9542-d9df6061b563
      iscontainedinside:
        - cad62f0d-0fa3-4ffb-ba8b-e0105a215fb3
        - cad62f0d-0fa3-4ffb-ba8b-e0105a215fb3
    0d15f27f-8d6c-4b1c-bed7-f99581fd2b8b:
      size:
        width: 230
        height: 250
      position:
        x: 470
        'y': 370
      z: 1
      parent: cad62f0d-0fa3-4ffb-ba8b-e0105a215fb3
      embeds:
        - 89e09378-efbb-4e9a-b815-78f41663c9ba
        - 215b2509-b0d9-429d-957f-8a40dfdc0355
      iscontainedinside:
        - cad62f0d-0fa3-4ffb-ba8b-e0105a215fb3
        - cad62f0d-0fa3-4ffb-ba8b-e0105a215fb3
    bcca50e2-1b9b-416a-9b50-6e6120ed935c:
      size:
        width: 100
        height: 100
      position:
        x: 100
        'y': 250
      z: 1
      parent: cad62f0d-0fa3-4ffb-ba8b-e0105a215fb3
      embeds: []
      iscontainedinside:
        - cad62f0d-0fa3-4ffb-ba8b-e0105a215fb3
        - cad62f0d-0fa3-4ffb-ba8b-e0105a215fb3
    ccd87952-210d-498d-8ba0-0772fb2f1a65:
      size:
        width: 60
        height: 60
      position:
        x: 310
        'y': 290
      z: 1
      parent: cad62f0d-0fa3-4ffb-ba8b-e0105a215fb3
      embeds: []
    a0f58d58-d9db-4c9d-b8e3-4f5b9398c0b1:
      size:
        width: 100
        height: 100
      position:
        x: 360
        'y': 20
      z: 0
      embeds:
        - 9baefa4a-3917-4bbc-827c-21eb5cb1ff1f
      iscontainedinside:
        - cad62f0d-0fa3-4ffb-ba8b-e0105a215fb3
    9baefa4a-3917-4bbc-827c-21eb5cb1ff1f:
      size:
        width: 60
        height: 60
      position:
        x: 380
        'y': 40
      z: 1
      parent: a0f58d58-d9db-4c9d-b8e3-4f5b9398c0b1
      embeds: []
      isassociatedwith:
        - ccd87952-210d-498d-8ba0-0772fb2f1a65
      iscontainedinside:
        - a0f58d58-d9db-4c9d-b8e3-4f5b9398c0b1
        - a0f58d58-d9db-4c9d-b8e3-4f5b9398c0b1
    491d4130-1f07-4b4d-80e9-9a8a3a526909:
      size:
        width: 60
        height: 60
      position:
        x: 240
        'y': 50
      z: 2
      parent: ca2fd767-3130-4e40-861e-673e8d78ee5a
      embeds: []
      iscontainedinside:
        - ca2fd767-3130-4e40-861e-673e8d78ee5a
        - ca2fd767-3130-4e40-861e-673e8d78ee5a
    9b4996d8-76d0-410a-85b2-b5791aa13753:
      size:
        width: 60
        height: 60
      position:
        x: 483
        'y': 47
      z: 2
      parent: 41356c17-0971-45ae-aad0-5783024dcbb2
      embeds: []
      iscontainedinside:
        - 41356c17-0971-45ae-aad0-5783024dcbb2
        - 41356c17-0971-45ae-aad0-5783024dcbb2
    ecee7473-760e-4417-bce5-753e5570474e:
      size:
        width: 60
        height: 60
      position:
        x: 130
        'y': 50
      z: 2
      parent: ca2fd767-3130-4e40-861e-673e8d78ee5a
      embeds: []
      iscontainedinside:
        - ca2fd767-3130-4e40-861e-673e8d78ee5a
        - ca2fd767-3130-4e40-861e-673e8d78ee5a
    938433ac-b9fd-45de-8ac2-e7f9ebe3f7ef:
      size:
        width: 60
        height: 60
      position:
        x: 610
        'y': 50
      z: 2
      parent: 41356c17-0971-45ae-aad0-5783024dcbb2
      embeds: []
      iscontainedinside:
        - 41356c17-0971-45ae-aad0-5783024dcbb2
        - 41356c17-0971-45ae-aad0-5783024dcbb2
    f9a2237e-e858-4a0f-b325-5c4c42e0c4cc:
      size:
        width: 60
        height: 60
      position:
        x: 380
        'y': 140
      z: 1
      parent: cad62f0d-0fa3-4ffb-ba8b-e0105a215fb3
      embeds: []
      isassociatedwith:
        - 491d4130-1f07-4b4d-80e9-9a8a3a526909
        - 9b4996d8-76d0-410a-85b2-b5791aa13753
        - 838505d9-66c8-4f6e-a53a-9e92d7ea9cf4
      iscontainedinside:
        - ca2fd767-3130-4e40-861e-673e8d78ee5a
        - 41356c17-0971-45ae-aad0-5783024dcbb2
    0304f5e2-d1e9-4fc0-9542-d9df6061b563:
      size:
        width: 60
        height: 60
      position:
        x: 150
        'y': 430
      z: 2
      parent: a3ebeab3-3f21-4c0e-9ddb-388dda810fef
      embeds: []
      iscontainedinside:
        - a3ebeab3-3f21-4c0e-9ddb-388dda810fef
        - ca2fd767-3130-4e40-861e-673e8d78ee5a
        - a3ebeab3-3f21-4c0e-9ddb-388dda810fef
    215b2509-b0d9-429d-957f-8a40dfdc0355:
      size:
        width: 60
        height: 60
      position:
        x: 510
        'y': 430
      z: 2
      parent: 0d15f27f-8d6c-4b1c-bed7-f99581fd2b8b
      embeds: []
      iscontainedinside:
        - 0d15f27f-8d6c-4b1c-bed7-f99581fd2b8b
        - 41356c17-0971-45ae-aad0-5783024dcbb2
        - 0d15f27f-8d6c-4b1c-bed7-f99581fd2b8b
    d49f2930-811c-4c46-bc11-c6b1623a838d:
      size:
        width: 60
        height: 60
      position:
        x: 250
        'y': 530
      z: 2
      parent: a3ebeab3-3f21-4c0e-9ddb-388dda810fef
      embeds: []
      iscontainedinside:
        - a3ebeab3-3f21-4c0e-9ddb-388dda810fef
        - ca2fd767-3130-4e40-861e-673e8d78ee5a
        - a3ebeab3-3f21-4c0e-9ddb-388dda810fef
    89e09378-efbb-4e9a-b815-78f41663c9ba:
      size:
        width: 60
        height: 60
      position:
        x: 500
        'y': 540
      z: 2
      parent: 0d15f27f-8d6c-4b1c-bed7-f99581fd2b8b
      embeds: []
      iscontainedinside:
        - 0d15f27f-8d6c-4b1c-bed7-f99581fd2b8b
        - 41356c17-0971-45ae-aad0-5783024dcbb2
        - 0d15f27f-8d6c-4b1c-bed7-f99581fd2b8b
    95afef30-dc0a-4ab0-8f22-aaa1a89262b5:
      size:
        width: 60
        height: 60
      position:
        x: 800
        'y': -20
      z: 0
      embeds: []
      iscontainedinside:
        - cad62f0d-0fa3-4ffb-ba8b-e0105a215fb3
    58419deb-5a5b-48df-b0c1-56ca9a5626ba:
      size:
        width: 60
        height: 60
      position:
        x: -70
        'y': 150
      z: 0
      embeds: []
      iscontainedinside:
        - cad62f0d-0fa3-4ffb-ba8b-e0105a215fb3
    e3372fc3-5da6-4008-b022-8adace4b4b94:
      size:
        width: 60
        height: 60
      position:
        x: 800
        'y': 140
      z: 0
      embeds: []
      iscontainedinside:
        - cad62f0d-0fa3-4ffb-ba8b-e0105a215fb3
    c73eb110-6a70-4194-a28b-99bb0d646172:
      size:
        width: 60
        height: 60
      position:
        x: 800
        'y': 300
      z: 0
      embeds: []
      iscontainedinside:
        - cad62f0d-0fa3-4ffb-ba8b-e0105a215fb3
    a9d8dbe5-c027-42a3-bdf2-8e8276c8851e:
      size:
        width: 60
        height: 60
      position:
        x: 800
        'y': 550
      z: 0
      embeds: []
      iscontainedinside:
        - cad62f0d-0fa3-4ffb-ba8b-e0105a215fb3
    29c4413d-4094-4d01-b602-06d14eaf10a3:
      source:
        id: bcca50e2-1b9b-416a-9b50-6e6120ed935c
      target:
        id: a3ebeab3-3f21-4c0e-9ddb-388dda810fef
      z: 1
    08a0c879-792e-402a-8076-c9f188afaffd:
      source:
        id: bcca50e2-1b9b-416a-9b50-6e6120ed935c
      target:
        id: 0d15f27f-8d6c-4b1c-bed7-f99581fd2b8b
      z: 1
    3bb7fba2-5b98-482e-925e-b0dcf31fc418:
      source:
        id: a0f58d58-d9db-4c9d-b8e3-4f5b9398c0b1
      target:
        id: ca2fd767-3130-4e40-861e-673e8d78ee5a
      z: 0
    99011213-4261-420f-b0f2-9f99df334a5f:
      source:
        id: a0f58d58-d9db-4c9d-b8e3-4f5b9398c0b1
      target:
        id: 41356c17-0971-45ae-aad0-5783024dcbb2
      z: 0
    838505d9-66c8-4f6e-a53a-9e92d7ea9cf4:
      size:
        width: 60
        height: 60
      position:
        x: -70
        'y': 230
      z: 0
      embeds: []
      iscontainedinside:
        - cad62f0d-0fa3-4ffb-ba8b-e0105a215fb3
    dc109f88-cee2-4d24-a502-e28d7497ee22:
      source:
        id: cad62f0d-0fa3-4ffb-ba8b-e0105a215fb3
      target:
        id: ccd87952-210d-498d-8ba0-0772fb2f1a65
      z: 0
    87cbe0f5-7bd7-43ba-b2d8-1b9cc61cee6c:
      size:
        width: 60
        height: 60
      position:
        x: 430
        'y': 250
      z: 1
      parent: cad62f0d-0fa3-4ffb-ba8b-e0105a215fb3
      embeds: []
      iscontainedinside:
        - cad62f0d-0fa3-4ffb-ba8b-e0105a215fb3
        - cad62f0d-0fa3-4ffb-ba8b-e0105a215fb3
Parameters:
  AmiName:
    Description: >-
      Name of the AWS AMI to use (Search AMI Name:
      amzn2-ami-hvm-2.0.*-x86_64-gp2). Default is provided on 2019-09-10
    Type: String
    MinLength: '12'
    MaxLength: '25'
    Default: ami-00aa4671cbf840d82
    AllowedPattern: ami-.*
    ConstraintDescription: Must start with ami-*
  KeyName:
    Description: Name of your SSH Key to access all the resources.
    Type: String
  Az1:
    Description: First Availability Zone to use
    Type: 'AWS::EC2::AvailabilityZone::Name'
    Default: eu-central-1a
  Az2:
    Description: Second Availability Zone to use
    Type: 'AWS::EC2::AvailabilityZone::Name'
    Default: eu-central-1b
Resources:
# VPC
  DemoNetwork:
    Type: 'AWS::EC2::VPC'
    Properties:
      CidrBlock: 10.10.0.0/16
      Tags:
        - Key: Name
          Value: DemoNetwork
        - Key: Env
          Value: Demo
    Metadata:
      'AWS::CloudFormation::Designer':
        id: cad62f0d-0fa3-4ffb-ba8b-e0105a215fb3
  InternetGateway:
    Type: 'AWS::EC2::InternetGateway'
    Properties:
      Tags:
        - Key: Name
          Value: InternetGateway
        - Key: Env
          Value: Demo
    Metadata:
      'AWS::CloudFormation::Designer':
        id: ccd87952-210d-498d-8ba0-0772fb2f1a65
  AttachGateway:
    Type: 'AWS::EC2::VPCGatewayAttachment'
    Properties:
      VpcId: !Ref DemoNetwork
      InternetGatewayId: !Ref InternetGateway
    Metadata:
      'AWS::CloudFormation::Designer':
        id: dc109f88-cee2-4d24-a502-e28d7497ee22
# Public Subnets and Routing
  PublicAZ1Subnet:
    Type: 'AWS::EC2::Subnet'
    Properties:
      AvailabilityZone: !Ref Az1
      VpcId: !Ref DemoNetwork
      CidrBlock: 10.10.11.0/24
      Tags:
        - Key: Name
          Value: PublicAZ1Subnet
        - Key: Env
          Value: Demo
    Metadata:
      'AWS::CloudFormation::Designer':
        id: ca2fd767-3130-4e40-861e-673e8d78ee5a
  PublicAZ2Subnet:
    Type: 'AWS::EC2::Subnet'
    Properties:
      AvailabilityZone: !Ref Az2
      VpcId: !Ref DemoNetwork
      CidrBlock: 10.10.12.0/24
      Tags:
        - Key: Name
          Value: PublicAZ2Subnet
        - Key: Env
          Value: Demo
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 41356c17-0971-45ae-aad0-5783024dcbb2
  PublicRoutingTable:
    Type: 'AWS::EC2::RouteTable'
    Properties:
      VpcId: !Ref DemoNetwork
      Tags:
        - Key: Name
          Value: PublicRoutingTable
        - Key: Env
          Value: Demo
    Metadata:
      'AWS::CloudFormation::Designer':
        id: a0f58d58-d9db-4c9d-b8e3-4f5b9398c0b1
  PublicRouteEntry:
    Type: 'AWS::EC2::Route'
    Properties:
      RouteTableId: !Ref PublicRoutingTable
      GatewayId: !Ref InternetGateway
      DestinationCidrBlock: 0.0.0.0/0
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 9baefa4a-3917-4bbc-827c-21eb5cb1ff1f
  PublicAZ1SubnetRoute:
    Type: 'AWS::EC2::SubnetRouteTableAssociation'
    Properties:
      RouteTableId: !Ref PublicRoutingTable
      SubnetId: !Ref PublicAZ1Subnet
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 3bb7fba2-5b98-482e-925e-b0dcf31fc418
  PublicAZ2SubnetRoute:
    Type: 'AWS::EC2::SubnetRouteTableAssociation'
    Properties:
      SubnetId: !Ref PublicAZ2Subnet
      RouteTableId: !Ref PublicRoutingTable
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 99011213-4261-420f-b0f2-9f99df334a5f
# Private Subnets and Routing
  PrivateAZ1Subnet:
    Type: 'AWS::EC2::Subnet'
    Properties:
      AvailabilityZone: !Ref Az1
      VpcId: !Ref DemoNetwork
      CidrBlock: 10.10.21.0/24
      Tags:
        - Key: Name
          Value: PrivateAZ1Subnet
        - Key: Env
          Value: Demo
    Metadata:
      'AWS::CloudFormation::Designer':
        id: a3ebeab3-3f21-4c0e-9ddb-388dda810fef
  PrivateAZ2Subnet:
    Type: 'AWS::EC2::Subnet'
    Properties:
      AvailabilityZone: !Ref Az2
      VpcId: !Ref DemoNetwork
      CidrBlock: 10.10.22.0/24
      Tags:
        - Key: Name
          Value: PrivateAZ2Subnet
        - Key: Env
          Value: Demo
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 0d15f27f-8d6c-4b1c-bed7-f99581fd2b8b
  PrivateRoutingTable:
    Type: 'AWS::EC2::RouteTable'
    Properties:
      VpcId: !Ref DemoNetwork
      Tags:
        - Key: Name
          Value: PrivateRoutingTable
        - Key: Env
          Value: Demo
    Metadata:
      'AWS::CloudFormation::Designer':
        id: bcca50e2-1b9b-416a-9b50-6e6120ed935c
  PrivateAZ1SubnetRoute:
    Type: 'AWS::EC2::SubnetRouteTableAssociation'
    Properties:
      RouteTableId: !Ref PrivateRoutingTable
      SubnetId: !Ref PrivateAZ1Subnet
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 29c4413d-4094-4d01-b602-06d14eaf10a3
  PrivateAZ2SubnetRoute:
    Type: 'AWS::EC2::SubnetRouteTableAssociation'
    Properties:
      RouteTableId: !Ref PrivateRoutingTable
      SubnetId: !Ref PrivateAZ2Subnet
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 08a0c879-792e-402a-8076-c9f188afaffd
# Load Balancers, Servers and Security Groups
## Bastion
  BastionSG:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: Bastion security group
      VpcId: !Ref DemoNetwork
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: '22'
          ToPort: '22'
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: BastionSG
        - Key: Env
          Value: Demo
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 58419deb-5a5b-48df-b0c1-56ca9a5626ba
  Bastion:
    Type: 'AWS::EC2::Instance'
    Properties:
      KeyName: !Ref KeyName
      ImageId: !Ref AmiName
      InstanceType: t2.nano
      AvailabilityZone: !Ref Az1
      Tags:
        - Key: Name
          Value: Bastion
        - Key: Env
          Value: Demo
      BlockDeviceMappings:
        - DeviceName: /dev/xvda
          Ebs:
            VolumeSize: '8'
      NetworkInterfaces:
        - AssociatePublicIpAddress: 'True'
          DeleteOnTermination: 'True'
          SubnetId: !Ref PublicAZ1Subnet
          DeviceIndex: '0'
          GroupSet:
            - !Ref BastionSG
    Metadata:
      'AWS::CloudFormation::Designer':
        id: ecee7473-760e-4417-bce5-753e5570474e
  CommonManagementSG:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: Common Management security group
      VpcId: !Ref DemoNetwork
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: '22'
          ToPort: '22'
          SourceSecurityGroupId: !Ref BastionSG
        - IpProtocol: icmp
          FromPort: '-1'
          ToPort: '-1'
          SourceSecurityGroupId: !Ref BastionSG
        - IpProtocol: icmp
          FromPort: '-1'
          ToPort: '-1'
          SourceSecurityGroupId: !Ref MonitoringSG
      Tags:
        - Key: Name
          Value: CommonManagementSG
        - Key: Env
          Value: Demo
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 87cbe0f5-7bd7-43ba-b2d8-1b9cc61cee6c
## WebApp
  WebAppLBSG:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: WebApp ELB security group
      VpcId: !Ref DemoNetwork
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: '443'
          ToPort: '443'
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: '80'
          ToPort: '80'
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: WebAppLBSG
        - Key: Env
          Value: Demo
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 838505d9-66c8-4f6e-a53a-9e92d7ea9cf4
  WebAppLB:
    Type: 'AWS::ElasticLoadBalancing::LoadBalancer'
    Properties:
      Instances:
        - !Ref WebApp1
        - !Ref WebApp2
      Subnets:
        - !Ref PublicAZ1Subnet
        - !Ref PublicAZ2Subnet
      LoadBalancerName: WebAppLB
      Listeners:
        - InstancePort: '80'
          InstanceProtocol: http
          LoadBalancerPort: '80'
          Protocol: http
      HealthCheck:
        HealthyThreshold: '2'
        Interval: '30'
        Target: 'HTTP:80/'
        Timeout: '5'
        UnhealthyThreshold: '2'
      Scheme: internet-facing
      ConnectionSettings:
        IdleTimeout: 150
      SecurityGroups:
        - !Ref WebAppLBSG
    Metadata:
      'AWS::CloudFormation::Designer':
        id: f9a2237e-e858-4a0f-b325-5c4c42e0c4cc
  WebAppSG:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: WebApp security group
      VpcId: !Ref DemoNetwork
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: '80'
          ToPort: '80'
          SourceSecurityGroupId: !Ref WebAppLBSG
        - IpProtocol: icmp
          FromPort: '-1'
          ToPort: '-1'
          SourceSecurityGroupId: !Ref WebAppLBSG
        - IpProtocol: tcp
          FromPort: '80'
          ToPort: '80'
          SourceSecurityGroupId: !Ref MonitoringSG
        - IpProtocol: tcp
          FromPort: '80'
          ToPort: '80'
          SourceSecurityGroupId: !Ref BastionSG
      Tags:
        - Key: Name
          Value: WebAppSG
        - Key: Env
          Value: Demo
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 95afef30-dc0a-4ab0-8f22-aaa1a89262b5
  WebApp1:
    Type: 'AWS::EC2::Instance'
    Properties:
      KeyName: !Ref KeyName
      ImageId: !Ref AmiName
      InstanceType: t2.nano
      AvailabilityZone: !Ref Az1
      Tags:
        - Key: Name
          Value: WebApp1
        - Key: Env
          Value: Demo
      BlockDeviceMappings:
        - DeviceName: /dev/xvda
          Ebs:
            VolumeSize: '8'
      UserData: !Base64 
        'Fn::Join':
          - ''
          - - |
              #!/bin/bash -x
            - |
              # Install the files and packages from the metadata
            - '/opt/aws/bin/cfn-init -v '
            - '         --stack '
            - !Ref 'AWS::StackName'
            - '         --resource WebApp1 '
            - '         --region '
            - !Ref 'AWS::Region'
            - |+

            - |
              # Signal the status from cfn-init
            - '/opt/aws/bin/cfn-signal -e $? '
            - '         --stack '
            - !Ref 'AWS::StackName'
            - '         --resource WebApp1 '
            - '         --region '
            - !Ref 'AWS::Region'
            - |+

      NetworkInterfaces:
        - AssociatePublicIpAddress: 'False'
          DeleteOnTermination: 'True'
          SubnetId: !Ref PublicAZ1Subnet
          DeviceIndex: '0'
          GroupSet:
            - !Ref WebAppSG
            - !Ref CommonManagementSG
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 491d4130-1f07-4b4d-80e9-9a8a3a526909
      'AWS::CloudFormation::Init':
        configSets:
          InstallAndRun:
            - Install
            - Configure
        Install:
          packages:
            yum:
              httpd: []
          files:
            /var/www/html/index.html:
              content: !Join 
                - ''
                - - |
                    <html>
                  - |2
                      <head>
                  - |2
                        <title>Demo Environment</title>
                  - |2
                      </head>
                  - |2
                      <body>
                  - |2
                        <h1>Demo Environment</h1>
                  - |2
                      </body>
                  - </html>
              mode: '000600'
              owner: apache
              group: apache
            /etc/cfn/cfn-hup.conf:
              content: !Join 
                - ''
                - - |
                    [main]
                  - stack=
                  - !Ref 'AWS::StackId'
                  - |+

                  - region=
                  - !Ref 'AWS::Region'
                  - |+

              mode: '000400'
              owner: root
              group: root
            /etc/cfn/hooks.d/cfn-auto-reloader.conf:
              content: !Join 
                - ''
                - - |
                    [cfn-auto-reloader-hook]
                  - |
                    triggers=post.update
                  - |
                    path=Resources.WebApp1.Metadata.AWS::CloudFormation::Init
                  - 'action=/opt/aws/bin/cfn-init -v '
                  - '         --stack '
                  - !Ref 'AWS::StackName'
                  - '         --resource WebApp1 '
                  - '         --configsets InstallAndRun '
                  - '         --region '
                  - !Ref 'AWS::Region'
                  - |+

                  - |
                    runas=root
              mode: '000400'
              owner: root
              group: root
          services:
            sysvinit:
              httpd:
                enabled: 'true'
                ensureRunning: 'true'
              cfn-hup:
                enabled: 'true'
                ensureRunning: 'true'
                files:
                  - /etc/cfn/cfn-hup.conf
                  - /etc/cfn/hooks.d/cfn-auto-reloader.conf
  WebApp2:
    Type: 'AWS::EC2::Instance'
    Properties:
      KeyName: !Ref KeyName
      ImageId: !Ref AmiName
      InstanceType: t2.nano
      AvailabilityZone: !Ref Az2
      Tags:
        - Key: Name
          Value: WebApp2
        - Key: Env
          Value: Demo
      BlockDeviceMappings:
        - DeviceName: /dev/xvda
          Ebs:
            VolumeSize: '8'
      UserData: !Base64 
        'Fn::Join':
          - ''
          - - |
              #!/bin/bash -x
            - |
              # Install the files and packages from the metadata
            - '/opt/aws/bin/cfn-init -v '
            - '         --stack '
            - !Ref 'AWS::StackName'
            - '         --resource WebApp2 '
            - '         --region '
            - !Ref 'AWS::Region'
            - |+

            - |
              # Signal the status from cfn-init
            - '/opt/aws/bin/cfn-signal -e $? '
            - '         --stack '
            - !Ref 'AWS::StackName'
            - '         --resource WebApp2 '
            - '         --region '
            - !Ref 'AWS::Region'
            - |+

      NetworkInterfaces:
        - AssociatePublicIpAddress: 'False'
          DeleteOnTermination: 'True'
          SubnetId: !Ref PublicAZ2Subnet
          DeviceIndex: '0'
          GroupSet:
            - !Ref WebAppSG
            - !Ref CommonManagementSG
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 9b4996d8-76d0-410a-85b2-b5791aa13753
      'AWS::CloudFormation::Init':
        configSets:
          InstallAndRun:
            - Install
            - Configure
        Install:
          packages:
            yum:
              httpd: []
          files:
            /var/www/html/index.html:
              content: !Join 
                - ''
                - - |
                    <html>
                  - |2
                      <head>
                  - |2
                        <title>Demo Environment</title>
                  - |2
                      </head>
                  - |2
                      <body>
                  - |2
                        <h1>Demo Environment</h1>
                  - |2
                      </body>
                  - </html>
              mode: '000600'
              owner: apache
              group: apache
            /etc/cfn/cfn-hup.conf:
              content: !Join 
                - ''
                - - |
                    [main]
                  - stack=
                  - !Ref 'AWS::StackId'
                  - |+

                  - region=
                  - !Ref 'AWS::Region'
                  - |+

              mode: '000400'
              owner: root
              group: root
            /etc/cfn/hooks.d/cfn-auto-reloader.conf:
              content: !Join 
                - ''
                - - |
                    [cfn-auto-reloader-hook]
                  - |
                    triggers=post.update
                  - |
                    path=Resources.WebApp2.Metadata.AWS::CloudFormation::Init
                  - 'action=/opt/aws/bin/cfn-init -v '
                  - '         --stack '
                  - !Ref 'AWS::StackName'
                  - '         --resource WebApp2 '
                  - '         --configsets InstallAndRun '
                  - '         --region '
                  - !Ref 'AWS::Region'
                  - |+

                  - |
                    runas=root
              mode: '000400'
              owner: root
              group: root
          services:
            sysvinit:
              httpd:
                enabled: 'true'
                ensureRunning: 'true'
              cfn-hup:
                enabled: 'true'
                ensureRunning: 'true'
                files:
                  - /etc/cfn/cfn-hup.conf
                  - /etc/cfn/hooks.d/cfn-auto-reloader.conf
## Database
  DatabaseSG:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: Database security group
      VpcId: !Ref DemoNetwork
      Tags:
        - Key: Name
          Value: DatabaseSG
        - Key: Env
          Value: Demo
    Metadata:
      'AWS::CloudFormation::Designer':
        id: c73eb110-6a70-4194-a28b-99bb0d646172
  Database1:
    Type: 'AWS::EC2::Instance'
    Properties:
      KeyName: !Ref KeyName
      ImageId: !Ref AmiName
      InstanceType: t2.nano
      AvailabilityZone: !Ref Az1
      Tags:
        - Key: Name
          Value: Database1
        - Key: Env
          Value: Demo
      BlockDeviceMappings:
        - DeviceName: /dev/xvda
          Ebs:
            VolumeSize: '8'
      NetworkInterfaces:
        - AssociatePublicIpAddress: 'False'
          DeleteOnTermination: 'True'
          SubnetId: !Ref PrivateAZ1Subnet
          DeviceIndex: '0'
          GroupSet:
            - !Ref DatabaseSG
            - !Ref CommonManagementSG
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 0304f5e2-d1e9-4fc0-9542-d9df6061b563
  Database2:
    Type: 'AWS::EC2::Instance'
    Properties:
      KeyName: !Ref KeyName
      ImageId: !Ref AmiName
      InstanceType: t2.nano
      AvailabilityZone: !Ref Az2
      Tags:
        - Key: Name
          Value: Database2
        - Key: Env
          Value: Demo
      BlockDeviceMappings:
        - DeviceName: /dev/xvda
          Ebs:
            VolumeSize: '8'
      NetworkInterfaces:
        - AssociatePublicIpAddress: 'False'
          DeleteOnTermination: 'True'
          SubnetId: !Ref PrivateAZ2Subnet
          DeviceIndex: '0'
          GroupSet:
            - !Ref DatabaseSG
            - !Ref CommonManagementSG
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 215b2509-b0d9-429d-957f-8a40dfdc0355
## Notification Server
  NotificationSG:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: NotificationServer security group
      VpcId: !Ref DemoNetwork
      Tags:
        - Key: Name
          Value: NotificationSG
        - Key: Env
          Value: Demo
    Metadata:
      'AWS::CloudFormation::Designer':
        id: e3372fc3-5da6-4008-b022-8adace4b4b94
  NotificationServer:
    Type: 'AWS::EC2::Instance'
    Properties:
      KeyName: !Ref KeyName
      ImageId: !Ref AmiName
      InstanceType: t2.nano
      AvailabilityZone: !Ref Az2
      Tags:
        - Key: Name
          Value: NotificationServer
        - Key: Env
          Value: Demo
      BlockDeviceMappings:
        - DeviceName: /dev/xvda
          Ebs:
            VolumeSize: '8'
      NetworkInterfaces:
        - AssociatePublicIpAddress: 'False'
          DeleteOnTermination: 'True'
          SubnetId: !Ref PrivateAZ2Subnet
          DeviceIndex: '0'
          GroupSet:
            - !Ref NotificationSG
            - !Ref CommonManagementSG
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 938433ac-b9fd-45de-8ac2-e7f9ebe3f7ef
## Monitoring
  MonitoringSG:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: Monitoring security group
      VpcId: !Ref DemoNetwork
      Tags:
        - Key: Name
          Value: MonitoringSG
        - Key: Env
          Value: Demo
    Metadata:
      'AWS::CloudFormation::Designer':
        id: a9d8dbe5-c027-42a3-bdf2-8e8276c8851e
  Monitoring1:
    Type: 'AWS::EC2::Instance'
    Properties:
      KeyName: !Ref KeyName
      ImageId: !Ref AmiName
      InstanceType: t2.nano
      AvailabilityZone: !Ref Az1
      Tags:
        - Key: Name
          Value: Monitoring1
        - Key: Env
          Value: Demo
      BlockDeviceMappings:
        - DeviceName: /dev/xvda
          Ebs:
            VolumeSize: '8'
      NetworkInterfaces:
        - AssociatePublicIpAddress: 'False'
          DeleteOnTermination: 'True'
          SubnetId: !Ref PrivateAZ1Subnet
          DeviceIndex: '0'
          GroupSet:
            - !Ref MonitoringSG
            - !Ref CommonManagementSG
    Metadata:
      'AWS::CloudFormation::Designer':
        id: d49f2930-811c-4c46-bc11-c6b1623a838d
  Monitoring2:
    Type: 'AWS::EC2::Instance'
    Properties:
      KeyName: !Ref KeyName
      ImageId: !Ref AmiName
      InstanceType: t2.nano
      AvailabilityZone: !Ref Az2
      Tags:
        - Key: Name
          Value: Monitoring2
        - Key: Env
          Value: Demo
      BlockDeviceMappings:
        - DeviceName: /dev/xvda
          Ebs:
            VolumeSize: '8'
      NetworkInterfaces:
        - AssociatePublicIpAddress: 'False'
          DeleteOnTermination: 'True'
          SubnetId: !Ref PrivateAZ2Subnet
          DeviceIndex: '0'
          GroupSet:
            - !Ref MonitoringSG
            - !Ref CommonManagementSG
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 89e09378-efbb-4e9a-b815-78f41663c9ba
